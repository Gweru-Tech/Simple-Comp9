<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Ntando Hosting</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --secondary: #2563eb;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #ffffff;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: var(--text); background: var(--bg-light); }
        
        /* Layout */
        .dashboard-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--text); color: white; padding: 1rem 0; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-logo { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; }
        .user-info { padding: 1rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .user-name { font-weight: 600; margin-bottom: 0.25rem; }
        .user-domain { font-size: 0.875rem; opacity: 0.8; font-family: monospace; }
        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 0.5rem; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.3s; }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: var(--primary); color: white; }
        
        /* Main Content */
        .main-content { flex: 1; margin-left: 250px; padding: 2rem; }
        .header { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.875rem; }
        .header-actions { display: flex; gap: 1rem; align-items: center; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: white; color: var(--text); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        /* Content Sections */
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* Sites Grid */
        .sites-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .site-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .site-card:hover { transform: translateY(-4px); }
        .site-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
        .site-name { font-size: 1.25rem; font-weight: 600; }
        .site-status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-live { background: #d1fae5; color: #065f46; }
        .site-urls { margin-bottom: 1rem; }
        .url-item { font-family: monospace; font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem; }
        .url-primary { color: var(--primary); font-weight: 500; }
        .site-stats { display: flex; gap: 2rem; margin-bottom: 1rem; padding: 1rem 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .stat { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.875rem; color: var(--text-light); }
        .site-actions { display: flex; gap: 0.5rem; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }
        
        /* Create Site Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-content { background: white; margin: 2% auto; padding: 2rem; border-radius: 12px; max-width: 900px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .modal-close { font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        
        /* Editor Tabs */
        .editor-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1rem; }
        .editor-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; }
        .editor-tab.active { border-bottom-color: var(--primary); color: var(--primary); }
        .editor-content { display: none; }
        .editor-content.active { display: block; }
        
        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; font-family: inherit; }
        .form-group textarea { min-height: 200px; font-family: 'Monaco', 'Menlo', monospace; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        /* Templates Grid */
        .templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .template-card { border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; text-align: center; }
        .template-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .template-card.selected { border-color: var(--primary); background: #f0f4ff; }
        .template-icon { font-size: 3rem; margin-bottom: 1rem; }
        .template-name { font-weight: 600; margin-bottom: 0.5rem; }
        .template-desc { font-size: 0.875rem; color: var(--text-light); }
        
        /* Analytics */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 2rem; font-weight: bold; color: var(--primary); }
        
        /* Profile Settings */
        .settings-section { background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; }
        .settings-section h2 { margin-bottom: 1.5rem; }
        
        /* Toast Notification */
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--text); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 3000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
            .sites-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üöÄ Ntando</div>
            </div>
            
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-domain" id="userDomain">Loading...</div>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="showSection('sites')">
                            üì± My Sites
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('create')">
                            ‚ûï Create Site
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('templates')">
                            üé® Templates
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('analytics')">
                            üìä Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('domains')">
                            üåê Domains
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('settings')">
                            ‚öôÔ∏è Settings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/" class="nav-link" onclick="logout()">
                            üö™ Logout
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 id="pageTitle">My Sites</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showSection('create')">
                        ‚ûï Create New Site
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('templates')">
                        üé® Browse Templates
                    </button>
                </div>
            </div>

            <!-- Sites Section -->
            <section id="sites" class="content-section active">
                <div class="sites-grid" id="sitesGrid">
                    <!-- Sites will be loaded here -->
                </div>
            </section>

            <!-- Create Site Section -->
            <section id="create" class="content-section">
                <div class="settings-section">
                    <h2>Create New Site</h2>
                    <form id="createSiteForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="siteName">Site Name</label>
                                <input type="text" id="siteName" required placeholder="My Awesome Site">
                            </div>
                            <div class="form-group">
                                <label for="siteSlug">Site URL</label>
                                <input type="text" id="siteSlug" placeholder="my-awesome-site">
                                <small style="color: var(--text-light);">Will be accessible at: yoursite.ntando.app</small>
                            </div>
                        </div>
                        
                        <div class="editor-tabs">
                            <div class="editor-tab active" onclick="switchEditorTab('html')">HTML</div>
                            <div class="editor-tab" onclick="switchEditorTab('css')">CSS</div>
                            <div class="editor-tab" onclick="switchEditorTab('js')">JavaScript</div>
                        </div>
                        
                        <div id="htmlEditor" class="editor-content active">
                            <div class="form-group">
                                <label for="htmlContent">HTML Content</label>
                                <textarea id="htmlContent" placeholder="<!DOCTYPE html>&#10;<html>&#10;<head>&#10;    <title>Your Site</title>&#10;<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>&#10;<body>&#10;    <h1>Hello World!</h1>&#10;</body>&#10;</html>"><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Site</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
        h1 { color: #667eea; }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <h1>Welcome to My Site!</h1>
    <p>This is your new website hosted on Ntando.</p>
</body>
</html></textarea>
                            </div>
                        </div>
                        
                        <div id="cssEditor" class="editor-content">
                            <div class="form-group">
                                <label for="cssContent">CSS Content</label>
                                <textarea id="cssContent" placeholder="/* Add your custom CSS here */"></textarea>
                            </div>
                        </div>
                        
                        <div id="jsEditor" class="editor-content">
                            <div class="form-group">
                                <label for="jsContent">JavaScript Content</label>
                                <textarea id="jsContent" placeholder="// Add your JavaScript here"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enableDNS"> Enable DNS Forwarding (Advanced)
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">üöÄ Publish Site</button>
                            <button type="button" class="btn btn-secondary" onclick="previewSite()">üëÅÔ∏è Preview</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Templates Section -->
            <section id="templates" class="content-section">
                <div class="templates-grid" id="templatesGrid">
                    <!-- Templates will be loaded here -->
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Sites</h3>
                        <div class="value" id="totalSites">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Visits</h3>
                        <div class="value" id="totalVisits">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Sites</h3>
                        <div class="value" id="activeSites">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Storage Used</h3>
                        <div class="value" id="storageUsed">0 MB</div>
                    </div>
                </div>
            </section>

            <!-- Domains Section -->
            <section id="domains" class="content-section">
                <div class="settings-section">
                    <h2>Your Domain Extensions</h2>
                    <div id="domainsInfo">
                        <!-- Domain info will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="settings-section">
                    <h2>Profile Settings</h2>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username" readonly>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" readonly>
                        </div>
                        <div class="form-group">
                            <label for="primaryDomain">Primary Domain</label>
                            <input type="text" id="primaryDomain" readonly>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Edit Site Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Site</h2>
                <span class="modal-close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editSiteForm">
                <input type="hidden" id="editSiteId">
                <div class="form-group">
                    <label for="editSiteName">Site Name</label>
                    <input type="text" id="editSiteName" required>
                </div>
                
                <div class="editor-tabs">
                    <div class="editor-tab active" onclick="switchEditEditorTab('html')">HTML</div>
                    <div class="editor-tab" onclick="switchEditEditorTab('css')">CSS</div>
                    <div class="editor-tab" onclick="switchEditEditorTab('js')">JavaScript</div>
                </div>
                
                <div id="editHtmlEditor" class="editor-content active">
                    <div class="form-group">
                        <label for="editHtmlContent">HTML Content</label>
                        <textarea id="editHtmlContent"></textarea>
                    </div>
                </div>
                
                <div id="editCssEditor" class="editor-content">
                    <div class="form-group">
                        <label for="editCssContent">CSS Content</label>
                        <textarea id="editCssContent"></textarea>
                    </div>
                </div>
                
                <div id="editJsEditor" class="editor-content">
                    <div class="form-group">
                        <label for="editJsContent">JavaScript Content</label>
                        <textarea id="editJsContent"></textarea>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let userSites = [];
        let templates = [];
        let selectedTemplate = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadUserData();
            await loadSites();
            await loadTemplates();
            await loadDomainInfo();
            updateAnalytics();
        });

        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }
            
            // Verify token is valid by trying to load user data
            try {
                const userData = JSON.parse(localStorage.getItem('user') || '{}');
                if (!userData.username) {
                    throw new Error('Invalid user data');
                }
            } catch (error) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const userData = JSON.parse(localStorage.getItem('user') || '{}');
                currentUser = userData;
                
                document.getElementById('userName').textContent = userData.username || 'User';
                document.getElementById('userDomain').textContent = userData.subdomain || 'Loading...';
                document.getElementById('username').value = userData.username || '';
                document.getElementById('email').value = userData.email || '';
                document.getElementById('primaryDomain').value = userData.subdomain || '';
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load user sites
        async function loadSites() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user/sites', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    userSites = await response.json();
                    renderSites();
                } else {
                    showToast('Failed to load sites', 'error');
                }
            } catch (error) {
                console.error('Error loading sites:', error);
                showToast('Network error', 'error');
            }
        }

        // Render sites
        function renderSites() {
            const grid = document.getElementById('sitesGrid');
            
            if (userSites.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; background: white; border-radius: 12px;">
                        <h2 style="margin-bottom: 1rem;">No sites yet</h2>
                        <p style="color: var(--text-light); margin-bottom: 2rem;">Create your first site to get started!</p>
                        <button class="btn btn-primary" onclick="showSection('create')">‚ûï Create Your First Site</button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = userSites.map(site => `
                <div class="site-card">
                    <div class="site-header">
                        <div>
                            <div class="site-name">${site.name}</div>
                            <div class="site-urls">
                                <div class="url-item url-primary">${site.primaryDomain}</div>
                                ${site.aliasDomains.map(alias => `<div class="url-item">${alias}</div>`).join('')}
                            </div>
                        </div>
                        <span class="site-status status-live">üü¢ Live</span>
                    </div>
                    
                    <div class="site-stats">
                        <div class="stat">
                            <div class="stat-value">${site.visits || 0}</div>
                            <div class="stat-label">Visits</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${new Date(site.createdAt).toLocaleDateString()}</div>
                            <div class="stat-label">Created</div>
                        </div>
                    </div>
                    
                    <div class="site-actions">
                        <button class="btn btn-primary btn-small" onclick="window.open('${site.fullUrl}', '_blank')">üëÅÔ∏è View</button>
                        <button class="btn btn-secondary btn-small" onclick="editSite('${site.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteSite('${site.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Load templates
        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                if (response.ok) {
                    templates = await response.json();
                    renderTemplates();
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        // Render templates
        function renderTemplates() {
            const grid = document.getElementById('templatesGrid');
            
            grid.innerHTML = templates.map(template => `
                <div class="template-card" onclick="selectTemplate('${template.id}')" data-template-id="${template.id}">
                    <div class="template-icon">üé®</div>
                    <div class="template-name">${template.name}</div>
                    <div class="template-desc">${template.description}</div>
                </div>
            `).join('');
        }

        // Select template
        function selectTemplate(templateId) {
            selectedTemplate = templates.find(t => t.id === templateId);
            
            // Update UI
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-template-id="${templateId}"]`).classList.add('selected');
            
            // Switch to create section and populate form
            showSection('create');
            if (selectedTemplate) {
                document.getElementById('htmlContent').value = selectedTemplate.html;
                document.getElementById('siteName').value = selectedTemplate.name;
                document.getElementById('siteSlug').value = selectedTemplate.id + '-' + Date.now();
            }
        }

        // Load domain info
        async function loadDomainInfo() {
            try {
                const response = await fetch('/api/domains/extensions');
                if (response.ok) {
                    const domainInfo = await response.json();
                    renderDomainInfo(domainInfo);
                }
            } catch (error) {
                console.error('Error loading domain info:', error);
            }
        }

        // Render domain info
        function renderDomainInfo(domainInfo) {
            const container = document.getElementById('domainsInfo');
            
            container.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3>Your Primary Domain</h3>
                    <p style="font-family: monospace; font-size: 1.2rem; color: var(--primary);">${currentUser?.subdomain || 'Loading...'}</p>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3>Available Domain Extensions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        ${domainInfo.extensions.map(ext => {
                            const isPremium = domainInfo.customSubdomains[ext]?.premium;
                            return `
                                <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; ${isPremium ? 'background: #fef3c7;' : ''}">
                                    <div style="font-family: monospace; font-weight: bold;">${ext}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-light);">
                                        ${isPremium ? '‚≠ê Premium' : 'Standard'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div>
                    <h3>Your Site URLs Structure</h3>
                    <p style="color: var(--text-light);">Your sites will be available at:</p>
                    <div style="font-family: monospace; background: var(--bg-light); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                        yoursite.ntando.app<br>
                        yoursite.ntl.cloud<br>
                        yoursite.ntando.zw<br>
                        yoursite.ntandostore.com
                    </div>
                </div>
            `;
        }

        // Update analytics
        function updateAnalytics() {
            const totalSites = userSites.length;
            const totalVisits = userSites.reduce((sum, site) => sum + (site.visits || 0), 0);
            const activeSites = userSites.filter(site => site.published !== false).length;
            
            document.getElementById('totalSites').textContent = totalSites;
            document.getElementById('totalVisits').textContent = totalVisits;
            document.getElementById('activeSites').textContent = activeSites;
            document.getElementById('storageUsed').textContent = '0 MB'; // TODO: Calculate actual storage
        }

        // Show section
        function showSection(sectionId) {
            // Update nav
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Update page title
            const titles = {
                'sites': 'My Sites',
                'create': 'Create Site',
                'templates': 'Templates',
                'analytics': 'Analytics',
                'domains': 'Domains',
                'settings': 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';
        }

        // Switch editor tab
        function switchEditorTab(tab) {
            document.querySelectorAll('#create .editor-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#create .editor-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Editor').classList.add('active');
        }

        // Switch edit editor tab
        function switchEditEditorTab(tab) {
            document.querySelectorAll('#editModal .editor-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#editModal .editor-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('edit' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Editor').classList.add('active');
        }

        // Create site form submission
        document.getElementById('createSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                siteName: document.getElementById('siteName').value,
                siteSlug: document.getElementById('siteSlug').value,
                html: document.getElementById('htmlContent').value,
                css: document.getElementById('cssContent').value,
                js: document.getElementById('jsContent').value,
                enableDNS: document.getElementById('enableDNS').checked
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Site published successfully! ${result.message}`, 'success');
                    await loadSites();
                    showSection('sites');
                    // Reset form
                    document.getElementById('createSiteForm').reset();
                    document.getElementById('htmlContent').value = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Site</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
        h1 { color: #667eea; }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <h1>Welcome to My Site!</h1>
    <p>This is your new website hosted on Ntando.</p>
</body>
</html>`;
                } else {
                    showToast(result.error || 'Failed to create site', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        });

        // Edit site
        async function editSite(siteId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/sites/${siteId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Populate edit form
                    document.getElementById('editSiteId').value = data.site.id;
                    document.getElementById('editSiteName').value = data.site.name;
                    document.getElementById('editHtmlContent').value = data.html;
                    
                    // Show modal
                    document.getElementById('editModal').style.display = 'block';
                } else {
                    showToast('Failed to load site', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            }
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Edit site form submission
        document.getElementById('editSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                siteName: document.getElementById('editSiteName').value,
                html: document.getElementById('editHtmlContent').value,
                css: document.getElementById('editCssContent').value,
                js: document.getElementById('editJsContent').value
            };
            
            try {
                const token = localStorage.getItem('token');
                const siteId = document.getElementById('editSiteId').value;
                
                const response = await fetch(`/api/sites/${siteId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showToast('Site updated successfully!', 'success');
                    closeEditModal();
                    await loadSites();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to update site', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            }
        });

        // Delete site
        async function deleteSite(siteId) {
            if (!confirm('Are you sure you want to delete this site? This action cannot be undone.')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/sites/${siteId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showToast('Site deleted successfully', 'success');
                    await loadSites();
                } else {
                    showToast('Failed to delete site', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            }
        }

        // Preview site
        function previewSite() {
            const html = document.getElementById('htmlContent').value;
            const css = document.getElementById('cssContent').value;
            const js = document.getElementById('jsContent').value;
            
            let previewHtml = html;
            
            // Add CSS
            if (css) {
                previewHtml = previewHtml.replace('<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>', `<style>${css}</style><script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>`);
            }
            
            // Add JavaScript
            if (js) {
                previewHtml = previewHtml.replace('</body>', `<script>${js}</script></body>`);
            }
            
            // Open in new window
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(previewHtml);
            previewWindow.document.close();
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            if (event.target == editModal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>